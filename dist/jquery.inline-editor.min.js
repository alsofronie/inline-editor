/*! Inline Editor - v0.1.0 -  * 2015-08-13
 * * https://github.com/alsofronie/inline-editor
 * Copyright (c) 2015 Alex Sofronie; * Licensed MIT */ 
!function(a,b,c,d){"use strict";function e(b,c){this.element=b,this.$e=a(b),this.settings=a.extend({},g,c),this._defaults=g,this._name=f,this.init()}var f="inline_editor",g={textEmpty:"Add your text here",titleEmpty:"Add your title here",toolbox:{selection:["bold","italic","underline","strikethrough","|","h","p","|","align"],insert:["image","video","embed","section"],image:["normal","left","right","full"]},imageUpload:{name:"userfile",events:{}}};a.extend(e.prototype,{init:function(){this.prepare(),this.listenToEvents()},prepare:function(){this.$e.prop("contentEditable",!0)},listenToEvents:function(){var b=this;c.body.onclick=function(a){console.info("click on docment"),c.getSelection().isCollapsed&&b.hideToolbox(b),b.processInsertToolboxClick(b,a.target),b.processImageClick(b,a.target)},c.body.onkeyup=function(){b.hideToolbox(b)},this.$e.on("keydown.ied.kup",function(a){return 13===a.keyCode?(b.createNewSection(b),!1):void b.hideInsertToolbox(b)}),this.$e.on("keyup.ied.kup",function(a){(8===a.keyCode||46===a.keyCode)&&b.verifyEmptyElement(b)}),this.$e.on("click.ied.clk","section > p:empty",function(a){b._stopPropagation(a),console.info("click.ied.clk"),b.getInsertToolbox(b,a.target)}),this.$e.on("selectstart",function(){a(c).one("mouseup",function(){var a=this.getSelection();if(console.info("we have a selection"),a.isCollapsed)console.info("selection collapsed, hiding toolbox"),b.hideToolbox(b);else{console.info("selection is not collapsed"),b.currentSelection=a,b.setCurrents(b),console.info("current parent node: ",b.currentSelection.parentNode);var c=b.currentSelection.parentNode;b._tagIs(c,"figcaption")?console.info("selection is inside a figcaption, we do not show..."):(console.info("selection is legit, we show the toolbix"),b.getToolbox(b))}})})},currentSelection:null,currentParentElement:null,currentSection:null,currentInsertTarget:null,currentImageTarget:null,tbxSelection:null,tbxInsert:null,tbxImage:null,processImageClick:function(a,b){for(var d=c.getElementsByClassName("img-active"),e=0;e<d.length;e++){var f=d[e];f.className=""}return a._tagIs(b,"img")?(console.info("clicked on image"),b.className="img-active",a.getImageToolbox(a,b),a._selectNone(a)):a.hideImageToolbox(a),!1},processInsertToolboxClick:function(a,b){var d=c.getElementById("insert-panel");if(!d)return!0;if(d.contains(b))b.parentNode===d&&a._toggleClass(b.parentNode,"active");else{var e=a.getSelectionParentElement();e&&e.firstChild&&e.firstChild.innerHTML||a.hideInsertToolbox(a)}},verifyEmptyElement:function(a){var b=a.getSelectionParentElement(),c=b.children[0];a._tagIs(c,"figure")&&(c=c.lastChild);var d=c.innerHTML.trim().toLowerCase();console.info("the node is ",c),console.info("the node html is",d),("<br>"===d||"<br/>"===d||"<br />"===d||"&nbsp;"===d)&&(c.innerHTML=null,c.className="")},hideToolbox:function(a){null!==a.tbxSelection&&(a.tbxSelection.className="hidden")},hideInsertToolbox:function(a){null!==a.tbxInsert&&(a.tbxInsert.className="hidden")},hideImageToolbox:function(a){null!==a.tbxImage&&(a.tbxImage.className="hidden")},getToolbox:function(a){if(null===a.tbxSelection){var b=c.createElement("div");b.id="toolbox-panel";var e=c.createElement("ul");b.appendChild(e);for(var f in a.settings.toolbox.selection){var g=a.settings.toolbox.selection[f];if("|"!==g){if("function"==typeof a.toolboxWidgets[g]){var h=a.toolboxWidgets[g](),i=c.createElement("li"),j=c.createElement("button");if(j.dataset.act=g,console.info("W is ",j),j.onclick=function(b){a._stopPropagation(b),console.info("event target is ",b.srcElement);var c=b.srcElement||b.target,d=c.dataset.act;console.info("Calling on ",d),a.toolboxWidgets[d].call(a,!0)},h.wrap!==d&&(j.className="tbx tbx-"+h.wrap),h.text!==d&&j.appendChild(c.createTextNode(h.text)),h.icon!==d){var k=c.createElement("i");k.className="icon icon-"+h.icon,j.appendChild(k)}i.appendChild(j),e.appendChild(i)}}else{var l=c.createElement("li");l.className="divider",e.appendChild(l)}}c.body.appendChild(b),a.tbxSelection=b}a.tbxSelection.className="";var m=a.currentSelection.getRangeAt(0).cloneRange(),n=m.getClientRects()[0],o={width:a.tbxSelection.offsetWidth,height:a.tbxSelection.offsetHeight};return a.tbxSelection.style.left=n.left-Math.floor(o.width/2)+Math.floor(n.width/2)+"px",a.tbxSelection.style.top=n.top-3-o.height+"px",a.tbxSelection},getInsertToolbox:function(a,b){if(null===a.tbxInsert){var d,e,f,g=c.createElement("div");g.id="insert-panel",d=c.createElement("button"),d.appendChild(c.createTextNode("+")),g.appendChild(d);var h=c.createElement("ul");for(var i in a.settings.toolbox.insert){var j=a.settings.toolbox.insert[i];if("function"==typeof a.toolboxInsertWidgets[j]){var k=a.toolboxInsertWidgets[j]();e=c.createTextNode(k.text),d=c.createElement("button"),f=c.createElement("li"),d.dataset.act=j,d.onclick=function(b){a._stopPropagation(b);var c=b.target.dataset.act;a.toolboxInsertWidgets[c].call(a,!0)},d.appendChild(e),f.appendChild(d),h.appendChild(f)}}g.appendChild(h),c.body.appendChild(g),a.tbxInsert=g}a.tbxInsert.className="";var l=b.getBoundingClientRect();return a.tbxInsert.style.left=l.left-60+"px",a.tbxInsert.style.top=l.top-10+"px",a.currentInsertTarget=b,a.tbxInsert},getImageToolbox:function(a,b){if(null===a.tbxImage){var e=c.createElement("div");e.id="image-panel";var f=c.createElement("ul");e.appendChild(f);for(var g in a.settings.toolbox.image){var h=a.settings.toolbox.image[g];if("|"!==h){if("function"==typeof a.toolboxImageWidgets[h]){var i=a.toolboxImageWidgets[h](),j=c.createElement("li"),k=c.createElement("button");if(k.dataset.act=h,k.onclick=function(b){a._stopPropagation(b);var c=b.srcElement||b.target,d=c.dataset.act;a.toolboxImageWidgets[d].call(a,!0)},i.wrap!==d&&(k.className="tbx tbx-"+i.wrap),i.text!==d&&k.appendChild(c.createTextNode(i.text)),i.icon!==d){var l=c.createElement("i");l.className="icon icon-"+i.icon,k.appendChild(l)}j.appendChild(k),f.appendChild(j)}}else{var m=c.createElement("li");m.className="divider",f.appendChild(m)}}c.body.appendChild(e),a.tbxImage=e}a.currentImageTarget=b,a.tbxImage.className="";var n=a.currentImageTarget.getBoundingClientRect(),o={width:a.tbxImage.offsetWidth,height:a.tbxImage.offsetHeight};return a.tbxImage.style.left=n.left-Math.floor(o.width/2)+Math.floor(n.width/2)+"px",a.tbxImage.style.top=n.top-3-o.height+"px",a.tbxSelection},createNewSection:function(a){var d=a.settings,e=a.getSelectionParentElement(),f=c.createDocumentFragment(),g=c.createElement("section");g.className="col";var h=c.createElement("p");h.dataset.text=d.textEmpty,g.appendChild(h),f.appendChild(g),e.nextSibling?e.parentNode.insertBefore(f,e.nextSibling):e.appendNode(f);var i,j;return i=c.createRange(),i.selectNodeContents(h),i.collapse(!0),j=b.getSelection(),j.removeAllRanges(),j.addRange(i),a.getInsertToolbox(a,h),!1},getSelectionParentElement:function(){var a,d=null;for(b.getSelection?(a=b.getSelection(),a.rangeCount&&(d=a.getRangeAt(0).commonAncestorContainer,1!==d.nodeType&&(d=d.parentNode))):(a=c.selection)&&"Control"!==a.type&&(d=a.createRange().parentElement());d&&d.nodeName&&"section"!==d.nodeName.toLowerCase();)d=d.parentNode;return d},setCurrents:function(a){var b=a.getSelectionParentElement();a.currentSection=b,null!=b&&b.children&&b.children.length>0?a.currentParentElement=b.children[0]:(a.currentParentElement=null,console.error("Cannot find parent element"))},_stopPropagation:function(a){a=a||b.event,a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0},_toggleClass:function(a,b){a.classList.toggle(b)},_removeClasses:function(a,b){if(!b)return"";var c=a.className,d=new RegExp(b,"g");return c=c.replace(d,""),a.className=c.replace(/ +(?= )/g,""),c},_addClass:function(a,b){console.info("Adding class "+b+" to ",a),a.classList.add(b)},_tagIs:function(a,b){return console.info("matching against "+b+" the tag ",a),a&&null!==a&&a!==d&&b===a.tagName.toLowerCase()?!0:!1},_selectNone:function(a,c){var d=b.getSelection();d.removeAllRanges(),c!==!0&&a.hideToolbox(a)},_fileHandler:function(a,b,d,e,f){var g=new FileReader;g.onloadend=function(){var a=c.createElement("figure");a.setAttribute("contenteditable","false");var e=c.createElement("img");e.src=g.result,e.dataset.width=e.width,e.dataset.height=e.height,e.dataset.name=d.name,a.appendChild(e);var f=c.createElement("figcaption");f.dataset.text="Write a caption...",f.setAttribute("contenteditable","true"),a.appendChild(f),b.parentNode.removeChild(b),h.parentNode.insertBefore(a,h),h.parentNode.removeChild(h)},console.info("We got file "+e+"/"+f+": ",d),console.info("File reader: ",g),console.info("Current parent: ",a.currentInsertTarget);var h=a.currentInsertTarget;h.dataset.text="Please wait...",g.readAsDataURL(d)},toolboxWidgets:{bold:function(a){return a?void c.execCommand("bold",!1,!0):{icon:"bold"}},italic:function(a){return a?void c.execCommand("italic",!1,!0):{icon:"italic"}},underline:function(a){return a?void c.execCommand("underline",!1,!0):{icon:"underline"}},strikethrough:function(a){return a?void c.execCommand("strikeThrough",!1,!0):{icon:"strike"}},align:function(a){if(!a)return{icon:"align"};var b=this.currentParentElement;b&&console.info("The class list is ",b.classList)},h:function(a){if(!a)return{text:"H1",wrap:"b"};var d=this.currentParentElement;if(d){var e="h1";this._tagIs(d,"h1")?e="h2":this._tagIs(d,"h2")?e="h3":this._tagIs(d,"h3")?e="h4":this._tagIs(d,"h4")?e="h5":this._tagIs(d,"h5")?e="h6":this._tagIs(d,"h6")&&(e="p");var f=c.createElement(e);for(d.className&&(f.className=d.className);d.firstChild;)f.appendChild(d.firstChild);d.parentNode.insertBefore(f,d),d.parentNode.removeChild(d);var g=c.createRange();g.selectNodeContents(f);var h=b.getSelection();h.removeAllRanges(),h.addRange(g),this.currentSelection=h,this.currentParentElement=f,this.getToolbox(this)}}},toolboxInsertWidgets:{image:function(a){if(!a)return console.info("no run context"),{text:"IMAGE"};var b=this,d=c.createElement("input");d.type="file",d.name="userFile",d.multiple="true",d.style.position="absolute",d.style.left="-9999px",d.style.top="-9999px",d.onchange=function(a){b.settings.imageUpload.events.start&&b.settings.imageUpload.events.start.call(this,b,a);for(var c=this.files,e=0;e<c.length;e++)b._fileHandler(b,d,c[e],e,c.length)},c.body.appendChild(d),d.focus(),d.click()},video:function(a){return a?void console.info("Clicked on video button"):{text:"VIDEO"}},embed:function(a){return a?void console.info("Clicked on embed button"):{text:"EMBED"}},section:function(a){return a?void console.info("Clicked on new section"):{text:"S"}}},toolboxImageWidgets:{normal:function(a){return a?void console.info("Normal image class"):{text:"N"}},left:function(a){return a?void console.info("Left align"):{text:"L"}},right:function(a){return a?void console.info("Right align"):{text:"R"}},full:function(a){return a?void console.info("Full width"):{text:"F"}}}}),a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))})}}(jQuery,window,document);