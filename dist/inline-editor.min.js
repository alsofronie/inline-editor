/*! Inline Editor - v0.1.0 -  * 2015-08-18
 * * https://github.com/alsofronie/inline-editor
 * Copyright (c) 2015 Alex Sofronie; * Licensed MIT */ 
!function(a,b,c){"use strict";function d(a,b){var c;for(c in b)a.hasOwnProperty(c)&&("object"==typeof b[c]?a[c]=d(a[c],b[c]):a[c]=b[c]);return a}function e(b,c){b=b||a.event,b.stopPropagation&&b.stopPropagation(),b.cancelBubble=!0,c===!0&&b.preventDefault()}var f={lang:{text:"Add your text here",title:"Add your title here"},toolboxes:{selection:["bold","italic","underline","strikethrough","|","h","p","|","align"],insert:["plus","image","video","embed","section"],image:["pos","|","sec"]}},g={selection:{current:null,name:"selection",id:"seltbx-pane",position:"top",widgets:{bold:function(a){return a?void document.execCommand("bold",!1,!0):{icon:"bold"}},italic:function(a){return a?void document.execCommand("italic",!1,!0):{icon:"italic"}},underline:function(a){return a?void document.execCommand("underline",!1,!0):{icon:"underline"}},strikethrough:function(a){return a?void document.execCommand("strikeThrough",!1,!0):{icon:"strike"}},align:function(a){return a?(h.hasClass(this.sel,"text-center")?(h.removeClass(this.sel,"text-center"),h.addClass(this.sel,"text-right")):h.hasClass(this.sel,"text-right")?(h.removeClass(this.sel,"text-right"),h.addClass(this.sel,"text-justify")):h.hasClass(this.sel,"text-justify")?h.removeClass(this.sel,"text-justify"):h.addClass(this.sel,"text-center"),h.normalize(this.sel),h.select(this.sel),void 0):{icon:"align"}},p:function(a){if(!a)return{icon:"para"};if(!h.is(this.sel,"p")){var b=h.change(this.sel,"p",!1);h.normalize(b),h.select(b)}},h:function(a){if(!a)return{icon:"heading"};console.info("We need to change the current parent elment to a heading",this.sel);var b="h1";h.is(this.sel,"h1")?b="h2":h.is(this.sel,"h2")?b="h3":h.is(this.sel,"h3")?b="h4":h.is(this.sel,"h4")?b="h5":h.is(this.sel,"h5")&&(b="h6");var c=h.change(this.sel,b,!0);h.normalize(c),h.select(c)}}},insert:{current:null,name:"insert",id:"instbx-pane",position:"left",widgets:{plus:function(a){if(!a)return{icon:"close"};var b=document.getElementById("instbx-pane");h.toggleClass(b,"expanded")},image:function(a){if(!a)return{icon:"image"};var b=this,c=document.createElement("input");c.type="file",c.name="userFile",c.multiple="true",c.style.position="absolute",c.style.left="-9999px",c.style.top="-9999px",c.onchange=function(){for(var a=this.files,c=0;c<a.length;c++)b.uploadFile(a[c],c,a.length)},document.body.appendChild(c),c.focus(),c.click()},video:function(a){return a?void console.info("Clicked on INSERT VIDEO"):{icon:"video"}},embed:function(a){return a?void console.info("Clicked on INSERT EMBED"):{icon:"embed"}},section:function(a){return a?(h.change(this.sel,"hr"),this.createNewSection(),this.showToolbox(a),void 0):{icon:"hr"}}}},image:{current:null,name:"image",id:"imgtbx-pane",position:"top",widgets:{pos:function(a){if(!a)return{icon:"image-size"};var b=this.sec;h.hasClass(b,"wide")?(h.removeClass(b,"wide"),h.addClass(b,"full")):h.hasClass(b,"full")?h.removeClass(b,"full"):h.addClass(b,"wide")},sec:function(a){return a?void console.info("Must make the image very big"):{icon:"image-big"}}}}};a.InlineEditor=function(){function b(b){b=b?b:a.event,l.setSelection(),l.normalize();var c=l.getSelection();if(0===c.rangeCount)return!1;for(var d=c.getRangeAt(0).commonAncestorContainer;d!==l.src;){if(h.is(d,"body")||h.is(d,"html"))return l.hideToolbox(),!0;d=d.parentElement}c.isCollapsed?(l.hideToolbox(g.selection),h.is(l.sel,"p")&&!l.sel.hasChildNodes()?l.showToolbox(g.insert):l.hideToolbox(g.insert)):(l.showToolbox(g.selection),l.hideToolbox(g.insert),l.hideToolbox(g.image))}function i(b){if(b=b?b:a.event,l.setSelection(),13===b.keyCode)if(e(b,!0),b.shiftKey===!0){var c,d,f,i;window.getSelection?(c=window.getSelection(),c.getRangeAt&&c.rangeCount&&(d=c.getRangeAt(0),d.deleteContents(),d.collapse(!1),f=h.create("br"),d.insertNode(f),d=d.cloneRange(),d.setStartAfter(f),d.setEndAfter(f),i=h.createText("..."),d.insertNode(i),d.selectNode(i),c.removeAllRanges(),c.addRange(d),""!==i.nextSibling.nodeValue&&c.deleteFromDocument())):document.selection&&document.selection.createRange&&(document.selection.createRange().text="<br>")}else console.info("creating new section: ",b),l.createNewSection();else console.info("need to hide toolboxes"),l.hideToolbox(g.insert)}function j(b){b=b?b:a.event,l.setSelection(),(8===b.keyCode||46===b.keyCode)&&l.verifyEmptyElement()}function k(b){b=b?b:a.event;var c=b.target;if(h.is(c,"img")&&h.is(c.parentElement,"figure"))h.addClass(c,"img-active"),l.selectNone(),l.hideToolbox(g.insert),l.hideToolbox(g.selection),l.img=c,l.sec=h.hasParent(c,"section"),l.showToolbox(g.image);else{var d=document.getElementsByClassName("img-active");for(var e in d)d[e]&&d[e].classList&&h.is(d[e],"img")&&h.removeClass(d[e],"img-active");l.hideToolbox(g.image)}}if(this.src=null,this.sel=null,this.sec=null,this.img=null,this.settings=null,0===arguments.length)throw"Init error: we need the editor element!";1===arguments.length?(this.src=arguments[0],this.settings=f):2===arguments.length&&"object"==typeof arguments[1]&&(this.src=arguments[0],this.settings=d(f,arguments[1])),this.src.classList.add("ied-article"),h.attr(this.src,"contenteditable","true");var l=this;document.addEventListener("selectionchange",b),this.src.addEventListener("keydown",i),this.src.addEventListener("keyup",j),this.src.addEventListener("click",k),this.setup=function(a){"object"==typeof a&&(this.settings=d(this.settings,a))},this.getSelection=function(){if(window.getSelection)return window.getSelection();var a=document.selection;return a&&"Control"!==a.type?a:null},this.createNewSection=function(){var a=document.createElement("section");a.className="col";var b=document.createElement("p");b.dataset.text=this.settings.lang.text,a.appendChild(b),this.sec.nextSibling?this.sec.parentNode.insertBefore(a,this.sec.nextSibling):this.sec.appendNode(a);var c,d;return c=document.createRange(),c.selectNodeContents(b),c.collapse(!0),d=window.getSelection(),d.removeAllRanges(),d.addRange(c),this.setSelection(),!1},this.showToolbox=function(a){if(null===a.current){var b=h.create("div");b.id=a.id;var d=h.create("ul");b.appendChild(d);var e=a.widgets,f=this.settings.toolboxes[a.name];for(var g in f){var i=f[g];if("|"!==i)if(e[i]){var j=e[i](!1),k=h.create("li"),l=h.create("button");if(l.dataset.act=i,j.icon!==c){var m=h.create("i","icon icon-"+j.icon);l.appendChild(m)}else j.text!==c&&l.appendChild(document.createTextNode(j.text));var n=this;l.addEventListener("click",function(b){console.info("event target is  now",b.srcElement);for(var c=b.srcElement||b.target;!h.is(c,"button");)c=c.parentNode;var d=c.dataset.act;e[d].call(n,a)}),k.appendChild(l),d.appendChild(k)}else console.error("We do not know how to handle ",i);else{var o=h.create("li","divider");d.appendChild(o)}}document.body.appendChild(b),a.current=b}a.current.className="";var p,q,r,s;return p=this.getSelection(),p.rangeCount>0?(q=p.getRangeAt(0).cloneRange(),r=q.getClientRects()[0],r=h.adjustRect(r)):null!==this.img&&(r=this.img.getBoundingClientRect(),r=h.adjustRect(r)),"top"===a.position?(s={width:a.current.offsetWidth,height:a.current.offsetHeight},a.current.style.left=r.left-Math.floor(s.width/2)+Math.floor(r.width/2)+"px",a.current.style.top=r.top-3-s.height+"px"):"left"===a.position&&(a.current.style.left=r.left-80+"px",a.current.style.top=r.top+"px"),a.current},this.hideToolbox=function(a){return null!==a&&a!==c?a&&a.current&&null!==a.current&&a.current!==c?(a.current.className="hidden",!0):!1:(this.hideToolbox(g.image),this.hideToolbox(g.selection),this.hideToolbox(g.insert),void 0)},this.setSelection=function(){var a=this.getSelection();if(0===a.rangeCount)return!1;for(var b=a.getRangeAt(0).commonAncestorContainer;b;){if(h.is(b,"body")||h.is(b,"html"))return!1;if(1===b.nodeType&&h.is(b,"section"))break;b=b.parentNode}if(b){for(this.sec=b,b=b.firstChild;1!==b.nodeType;)b=b.nextSibling;return this.sel=b,!0}return!1},this.normalize=function(){null!==this.sel&&h.normalize(this.sel)},this.verifyEmptyElement=function(){var a=this.sel;console.info("Verify empty on parent",a);var b=a;console.info("We need to check the node ",b),h.is(b,"figure")&&(b=b.lastChild);var c=b.innerHTML.trim().toLowerCase();console.info("html is ",c),("<br>"===c||"<br/>"===c||"<br />"===c||"&nbsp;"===c||""===c)&&(b.innerHTML=null,b.className="")},this.uploadFile=function(a,b,c){var d=new FileReader,e=this;d.onloadend=function(){var b=document.createElement("figure");b.setAttribute("contenteditable","false");var c=document.createElement("img");c.src=this.result,c.dataset.width=c.width,c.dataset.height=c.height,c.dataset.name=a.name,b.appendChild(c);var d=document.createElement("figcaption");d.dataset.text="Write a caption...",d.setAttribute("contenteditable","true"),b.appendChild(d),h.replaceWith(e.sel,b),e.hideToolbox(g.insert)},console.info("We got file "+b+"/"+c+": ",a),console.info("File reader: ",d),d.readAsDataURL(a)},this.selectNone=function(){var a=window.getSelection();a.removeAllRanges()}};var h={create:function(a,b){var d=document.createElement(a);return b!==c&&(d.className=b),d},createText:function(a){var b=document.createTextNode(a);return b},destroy:function(a){a.parentElement.removeChild(a)},attr:function(a,b,c){a.setAttribute(b,c)},is:function(a,b){return a&&null!==a&&a!==c?a.nodeType&&1!==a.nodeType?!1:(b=b.toLowerCase(),b===a.tagName.toLowerCase()):!1},change:function(a,b,c){console.info("Changing to "+b+" node ",a);var d="";c&&(d=a.className);var e=h.create(b);for(e.className=d;a.firstChild;)e.appendChild(a.firstChild);return a.parentNode.insertBefore(e,a),a.parentNode.removeChild(a),e},select:function(a){var b=document.createRange();b.selectNodeContents(a);var c=window.getSelection();c.removeAllRanges(),c.addRange(b)},hasClass:function(a,b){return a.classList.contains(b)},addClass:function(a,b){a.classList.add(b)},removeClass:function(a,b){a.classList.remove(b)},toggleClass:function(a,b){a.classList.toggle(b)},normalize:function(a){a.normalize()},hasParent:function(a,b){for(;;){if(console.info("waling on parent of ",a),h.is(a,b))return a;if(!a)break;if(h.is(a,"html"))break;a=a.parentElement}return!1},replaceWith:function(a,b){a.parentNode.insertBefore(b,a),h.destroy(a)},adjustRect:function(a){return{top:a.top+window.pageYOffset-document.documentElement.clientTop,left:a.left+window.pageXOffset-document.documentElement.clientLeft,width:a.width,height:a.height}}}}(window,document);